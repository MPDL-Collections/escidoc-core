<bean id="escidoc-core.txProxyTemplate"
	class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean"
	abstract="true" lazy-init="true">
	<property name="transactionManager">
		<ref bean="escidoc-core.txManager" />
	</property>
	<property name="transactionAttributes">
		<props>
			<prop key="*">PROPAGATION_REQUIRED,+EscidocException</prop>
		</props>
	</property>
</bean>

<tx:advice id="escidoc-core.txAdvice" transaction-manager="escidoc-core.txManager">
  <tx:attributes>
    <tx:method name="*" propagation="REQUIRED" rollback-for="de.escidoc.core.common.exceptions.system.SystemException, java.lang.RuntimeException"/>
  </tx:attributes>
</tx:advice>

<bean id="escidoc-core.txManager"
	class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
	<property name="dataSource">
		<ref bean="escidoc-core.DataSource" />
	</property>
</bean>

<bean id="jdbcTemplate"
	class="org.springframework.jdbc.core.JdbcTemplate">
	<property name="dataSource">
		<ref bean="escidoc-core.DataSource" />
	</property>
</bean>

<bean
	class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
	<property name="locations">
		<list>
            <value>file:${catalina.home}/conf/escidoc-core.properties</value>
            <value>file:${catalina.home}/conf/escidoc-core.custom.properties</value>
		</list>
	</property>
	<property name="ignoreResourceNotFound" value="true" />
</bean>

<bean id="escidoc-core.DataSource"
    class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close" lazy-init="true">
    <!-- specifying the initial size is important, otherwise the infrastructure 
         will hang up if after start-up multiple, concurrent accesses are
         immediately executed. -->
    <property name="initialSize" value="${escidoc-core.datasource.initialSize}"/>
    <property name="maxActive" value="${escidoc-core.datasource.maxActive}"/>
    <property name="maxIdle" value="${escidoc-core.datasource.maxIdle}"/>
    <property name="minIdle" value="${escidoc-core.datasource.minIdle}"/>
    <property name="maxWait" value="${escidoc-core.datasource.maxWait}"/>
    <property name="driverClassName"
        value="${escidoc-core.datasource.driverClassName}" />
    <property name="url" value="${escidoc-core.datasource.url}" />
    <property name="username" value="${escidoc-core.datasource.username}" />
    <property name="password" value="${escidoc-core.datasource.password}" />
</bean>

<bean id="fedora.triplestore.DataSource"
    class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close" lazy-init="true">
    <!-- see escidoc-core.DataSource for property descriptions -->
    <property name="initialSize" value="${triplestore.datasource.initialSize}"/>
    <property name="maxActive" value="${triplestore.datasource.maxActive}"/>
    <property name="maxIdle" value="${triplestore.datasource.maxIdle}"/>
    <property name="minIdle" value="${triplestore.datasource.minIdle}"/>
    <property name="maxWait" value="${triplestore.datasource.maxWait}"/>
    <property name="driverClassName"
        value="${triplestore.datasource.driverClassName}" />
    <property name="url" value="${triplestore.datasource.url}" />
    <property name="username" value="${triplestore.datasource.username}" />
    <property name="password" value="${triplestore.datasource.password}" />
</bean>

<bean id="common.CommonMethodMapper"
	class="de.escidoc.core.common.servlet.invocation.MethodMapper">
	<property name="descriptorFilenames">
		<list>
			<value>/META-INF/servlet/container.xml</value>
			<value>/META-INF/servlet/content-relation.xml</value>
			<value>/META-INF/servlet/context.xml</value>
			<value>/META-INF/servlet/item.xml</value>
			<value>/META-INF/servlet/ingest.xml</value>
			<value>/META-INF/servlet/content-model.xml</value>
			<value>/META-INF/servlet/organizational-unit.xml</value>
			<value>/META-INF/servlet/user-account.xml</value>
			<value>/META-INF/servlet/admin.xml</value>
			<value>/META-INF/servlet/stagingfile.xml</value>
		</list>
	</property>
</bean>

<jee:jndi-lookup id="common.local.QueueConnectionFactory" jndi-name="ConnectionFactory"/>

<!-- 
<bean id="om.remote.cacheMessageQueue"
	class="de.escidoc.core.common.util.service.RemoteJndiLocator"
	lazy-init="true">
	<property name="jndiName">
		<value>queue/ResourceCacheMessageQueue</value>
	</property>
	<property name="packageName">
		<value>de.escidoc.om.service</value>
	</property>
</bean>
 -->
 
<bean id="sb.remote.QueueConnectionFactory"
	class="de.escidoc.core.common.util.service.RemoteJndiLocator"
	lazy-init="true">
	<property name="jndiName">
		<value>ConnectionFactory</value>
	</property>
	<property name="packageName">
		<value>de.escidoc.sb.service</value>
	</property>
</bean>

<bean id="sm.remote.QueueConnectionFactory"
	class="de.escidoc.core.common.util.service.RemoteJndiLocator"
	lazy-init="true">
	<property name="jndiName">
		<value>ConnectionFactory</value>
	</property>
	<property name="packageName">
		<value>de.escidoc.core.sm.service</value>
	</property>
</bean>

<bean id="adm.remote.purgeMessageQueue"
        class="de.escidoc.core.common.util.service.RemoteJndiLocator"
        lazy-init="true">
        <property name="jndiName">
                <value>queue/PurgeMessageQueue</value>
        </property>
        <property name="packageName">
                <value>de.escidoc.adm.service</value>
        </property>
</bean>

<bean id="adm.remote.recacherMessageQueue"
	class="de.escidoc.core.common.util.service.RemoteJndiLocator"
	lazy-init="true">
	<property name="jndiName">
		<value>queue/RecacherMessageQueue</value>
	</property>
	<property name="packageName">
		<value>de.escidoc.adm.service</value>
	</property>
</bean>

<bean id="sb.remote.indexerMessageQueue"
        class="de.escidoc.core.common.util.service.RemoteJndiLocator"
        lazy-init="true">
        <property name="jndiName">
                <value>queue/IndexerMessageQueue</value>
        </property>
        <property name="packageName">
                <value>de.escidoc.sb.service</value>
        </property>
</bean>

<bean id="sm.remote.statisticMessageQueue"
	class="de.escidoc.core.common.util.service.RemoteJndiLocator"
	lazy-init="true">
	<property name="jndiName">
		<value>queue/StatisticMessageQueue</value>
	</property>
	<property name="packageName">
		<value>de.escidoc.core.sm.service</value>
	</property>
</bean>



<!-- security -->
<bean id="common.SessionFactory"
	class="org.springframework.orm.hibernate3.LocalSessionFactoryBean">
	<property name="dataSource">
		<ref bean="escidoc-core.DataSource" />
	</property>
	<property name="hibernateProperties">
		<props>
			<prop key="hibernate.transaction.factory_class">
				org.hibernate.transaction.JTATransactionFactory
			</prop>
			<prop key="hibernate.transaction.manager_lookup_class">
				${escidoc-core.hibernate.transaction.manager_lookup_class}
			</prop>
			<prop key="hibernate.dialect">
			    ${escidoc-core.hibernate.dialect}
			</prop>
			<!-- ehCache default provider cannot handle two session factories -->
			<prop key="hibernate.cache.provider_class">
				org.hibernate.cache.HashtableCacheProvider
			</prop>
			<prop key="hibernate.show_sql">false</prop>
			<prop key="jta.UserTransaction">${escidoc-core.jta.UserTransaction}</prop>
			<prop key="hibernate.connection.release_mode">auto</prop>
		</props>
	</property>
	<property name="mappingResources">
		<list>
			<value>
				de/escidoc/core/common/util/security/persistence/InvocationMapping.hbm.xml
			</value>
			<value>
				de/escidoc/core/common/util/security/persistence/MethodMapping.hbm.xml
			</value>
		</list>
	</property>
</bean>

<!-- 
        JMX 
 -->
 
<!-- exposing spring beans as MBeans that are annotated 
      (using appropriate JAVA5 annotations). If a MBean with the same name
      has been exposed before, the new exposal is skipped (ignoreExisting)  -->
<bean id="eSciDoc.core.common.MBeanExporter" 
    class="org.springframework.jmx.export.annotation.AnnotationMBeanExporter"
    lazy-init="false">
    <property name="autodetect" value="true"/>      
    <property name="registrationBehaviorName" value="REGISTRATION_IGNORE_EXISTING"/>
</bean>

<!-- end of JMX -->
 


